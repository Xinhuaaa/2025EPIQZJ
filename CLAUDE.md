# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an embedded C robotics project for STM32F407VET6 microcontroller implementing a **mobile robot with manipulation capabilities**. The robot has three main subsystems:

- **Chassis**: Mobile platform with 3-DOF movement (X, Y, Yaw) using ADRC control
- **Lift**: Vertical movement system with 4x M2006 motors (18cm wheels, 36:1 gear ratio)
- **Crawl**: Object manipulation system with multi-stage operations (lift → extend → grab → retract → lower)

## Build System

The project uses **Makefile** generated by STM32CubeMX with ARM GCC toolchain:

```bash
# Build the project
make

# Clean build artifacts
make clean

# Build specific targets
make build/TKX.elf    # ELF executable
make build/TKX.hex    # Intel HEX format
make build/TKX.bin    # Binary format
```

### VSCode/EIDE Integration

The project is configured for VSCode with EIDE extension:

```bash
# Through VSCode tasks (Ctrl+Shift+P)
# - "build": Build the project
# - "flash": Flash to device
# - "build and flash": Build and flash in one step
# - "rebuild": Clean and build
# - "clean": Clean build artifacts
```

## Architecture

### Layer Structure
```
Application/          # High-level robot control
├── Robot_task.c/h   # Main robot initialization
├── Chassis/         # Mobile platform control
├── Lift/            # Vertical movement system
└── Crawl/           # Object manipulation

modules/             # Hardware abstraction modules
├── dji_motor/       # DJI motor control (M2006/M3508)
├── ZDT_EmmV5/       # Stepper motor control
├── Hwt101/          # IMU sensor interface
├── servo/           # Servo motor control
├── PID/             # PID controller
└── ADRC/            # Active Disturbance Rejection Control

bsp/                 # Board support package
├── bsp_can/         # CAN bus abstraction
├── bsp_log/         # RTT-based logging system
├── bsp_dwt/         # High-precision timing
└── bsp_printf/      # Printf implementation
```

### Hardware Configuration
- **MCU**: STM32F407VET6 (ARM Cortex-M4F, 168MHz, FPU enabled)
- **RTOS**: FreeRTOS with CMSIS-RTOS V2
- **Communication**: CAN bus (DJI motors), Multiple UART (sensors), USB CDC
- **Sensors**: HWT101 IMU, various motor encoders
- **Actuators**: DJI M2006/M3508 motors, EMM V5 stepper motors, servo motors

## Development Workflow

### Debugging Setup
The project supports multiple debug interfaces:
- **J-Link**: Recommended for RTT logging (use "Debug: JLINK" launch config)
- **OpenOCD**: With CMSIS-DAP interface
- **pyOCD**: Alternative debugger

### Real-time Logging
Uses **SEGGER RTT** for real-time debugging output:

```c
// Logging levels available in bsp_log.h
LOGINFO("Info message");
LOGWARNING("Warning message");
LOGERROR("Error message");

// For floating point, use conversion first
float value = 123.45;
char str_buff[64];
Float2Str(str_buff, value);
printf_log("Float value: %s\n", str_buff);
```

**Important**: RTT logging requires J-Link debug session. Start debugging with "Debug: JLINK" configuration before opening RTT viewer.

### Code Organization Patterns

1. **Module Initialization**: All modules have `ModuleName_Init()` functions called from `Robot_Init()`
2. **Hardware Abstraction**: BSP layer isolates hardware-specific code
3. **Task-based Design**: FreeRTOS tasks for each major subsystem
4. **State Machines**: Used for complex sequential operations (especially in Crawl module)
5. **Control Systems**: ADRC and PID controllers for precise motion control

### Common Development Tasks

When adding new functionality:
1. Add BSP layer code for hardware abstraction if needed
2. Create module-level drivers for sensors/actuators
3. Implement application-level control logic
4. Add initialization calls to `Robot_Init()`
5. Use appropriate logging for debugging

### Motor Control Specifics
- **DJI Motors**: Use CAN bus communication, controlled via `dji_motor` module
- **Stepper Motors**: EMM V5 series, controlled via UART through `ZDT_EmmV5` module
- **Servo Motors**: PWM controlled through `servo` module
- **Control**: Multi-motor coordination with synchronized control loops

### Timing and Synchronization
- **DWT**: Use `DWT_Delay()` for precise microsecond delays
- **FreeRTOS**: Task-based scheduling with appropriate priorities
- **Interrupts**: Carefully managed interrupt priorities for real-time performance

## Key Files to Understand

- `Application/Robot_task.c`: Main system initialization sequence
- `bsp/log/bsp_log.h`: Logging macros and functions
- `modules/dji_motor/dji_motor.h`: Motor control interface
- `Inc/main.h`: Global includes and definitions
- `Inc/FreeRTOSConfig.h`: RTOS configuration